#load data from URL
url <- "https://ckan0.cf.opendata.inter.prod-toronto.ca/dataset/57b2285f-4f80-45fb-ae3e-41a02c3a137f/resource/54bddc5e-92d9-4102-89c1-43e82f8f4d2d/download/Business%20licences%20data.csv"
dest<- "c:/users/Public/Public Downloads"
download.file(url, dest)
setwd("~/Class/2024_1_GT_MGT6203_DataAnalyticInBiz/")
biz_data <- read.csv("c:/users/Public/Public Downloads",header = TRUE)
##########################################################
# This section is for import business data and clean up.
# The business data is download from https://open.toronto.ca/dataset/municipal-licensing-and-standards-business-licences-and-permits/
# Then it will be stored in local file as per setwd above
#Meaning of the data according to the readme from website are as follows
#Category=Type of licence or permit
#Licence No=Number. of licence issued by City of Toronto
#Operating Name=Name that company operates under
#Issued=Date of issue of licence/permit
#Client Name=Name that the licence is issued to
#Business Phone=Client Business Phone Number
#Business Phone Ext.=Client Business Phone Extension Number
#Licence Address Line 1=First line of client's business address
#Licence Address Line 2=Client address town and province
#Licence Address Line 3=Client address postal code
#Conditions=Restriction on the licence/permit recorded in the licensing system
#Free Form Conditions Line 1=Restriction/comment on the licence/permit
#Free Form Conditions Line 2=Continuation of line 1 
#Plate No.=Licence identifying plate, issued to most vehicles
#Endorsements=Activity permitted under the licence
#Cancel Date=Date the license or permit was cancelled
###################################################

biz_data$Category = as.factor(biz_data$Category)
biz_data$Licence.Address.Line.2 = as.factor(biz_data$Licence.Address.Line.2)
#biz_data$Licence.Address.Line.3 = as.factor(biz_data$Licence.Address.Line.3)
biz_data$Issued = as.Date(biz_data$Issued)
biz_data$Cancel.Date = as.Date(biz_data$Cancel.Date)
biz_data$Last.Record.Update = as.Date(biz_data$Last.Record.Update)
biz_data$Operating.Name <-ifelse(biz_data$Operating.Name =="",biz_data$Client.Name,biz_data$Operating.Name)

summary(biz_data)

#########
#remove biz that have cancel date as it indicates that business has already been cancelled (i.e. terminated)
# only select business in Toronto
# cleaned data is under biz_data (along the way, data will be backup to biz_data_bak)

biz_data_bak = biz_data
biz_data = biz_data[which(is.na(biz_data$Cancel.Date)),]
biz_data = biz_data[which(biz_data$Licence.Address.Line.2 == "TORONTO, ON"),]
biz_data = biz_data[which(biz_data$Licence.Address.Line.3 > "M3" &biz_data$Licence.Address.Line.3 < "M7"),]
biz_data = biz_data %>%
  select(-Cancel.Date)
biz_data$Post <- substr(biz_data$Licence.Address.Line.3, start = 1, stop = 3)
#make column to identify street name from Licence.Address.Line.1
#first extracting the address number. grab only the data that are after the first space
biz_data$Street <- sub("^\\S+\\s+",'', biz_data$Licence.Address.Line.1)
#first extracting the address number. remove number
#biz_data$Street = gsub("[[:digit:]]", "", biz_data$Licence.Address.Line.1)
biz_data$Street <- gsub("[[:digit:]]", "", biz_data$Street)

#remove other characters
#biz_data$Street <- sub('-//s ', '', biz_data$Street)
biz_data$Street <- sub('-  ', '', biz_data$Street)
biz_data$Street <- sub('&A ', '', biz_data$Street)
biz_data$Street <- sub('& A ', '', biz_data$Street)
biz_data$Street <- sub('&B ', '', biz_data$Street)
biz_data$Street <- sub('& B ', '', biz_data$Street)
biz_data$Street <- sub('&  ', '', biz_data$Street)
biz_data$Street <- sub('&& ', '', biz_data$Street)
biz_data$Street <- sub('& ', '', biz_data$Street)
biz_data$Street <- sub('/ ', '', biz_data$Street)
biz_data$Street <- sub('-A ', '', biz_data$Street)
biz_data$Street <- sub('A-', '', biz_data$Street)
biz_data$Street <- sub('- A ', '', biz_data$Street)
biz_data$Street <- sub('-B ', '', biz_data$Street)
biz_data$Street <- sub('- B ', '', biz_data$Street)
biz_data$Street <- sub("(?<=^.{0}),", "", biz_data$Street, perl = TRUE )
biz_data$Street <- sub("(?<=^.{0})&", "", biz_data$Street, perl = TRUE )
biz_data$Street <- sub("(?<=^.{0})/", "", biz_data$Street, perl = TRUE )
biz_data$Street <- sub("(?<=^.{0})-", "", biz_data$Street, perl = TRUE )

# as data is not clean, there are sometimes suite number or other suffix follow them. therefore, we clean that part up too.
biz_data$Street <- sub(", #.*", '', biz_data$Street)
biz_data$Street <- sub(" #.*", '', biz_data$Street)
biz_data$Street <- sub("#.*", '', biz_data$Street)
biz_data$Street <- sub(" ,.*", '', biz_data$Street)
biz_data$Street <- sub(",.*", '', biz_data$Street)


###################################################
# clean data and select for geo location
biz_data$StreetAddress = paste(biz_data$Licence.Address.Line.1)

##remove other characters from address one
biz_data$StreetAddress <- sub('-  ', '', biz_data$StreetAddress)
biz_data$StreetAddress <- sub('&A ', '', biz_data$StreetAddress)
biz_data$StreetAddress <- sub('& A ', '', biz_data$StreetAddress)
biz_data$StreetAddress <- sub('&B ', '', biz_data$StreetAddress)
biz_data$StreetAddress <- sub('& B ', '', biz_data$StreetAddress)
biz_data$StreetAddress <- sub('&  ', '', biz_data$StreetAddress)
biz_data$StreetAddress <- sub('&& ', '', biz_data$StreetAddress)
biz_data$StreetAddress <- sub('& ', '', biz_data$StreetAddress)
biz_data$StreetAddress <- sub('/ ', '', biz_data$StreetAddress)
biz_data$StreetAddress <- sub('-A ', '', biz_data$StreetAddress)
biz_data$StreetAddress <- sub('A-', '', biz_data$StreetAddress)
biz_data$StreetAddress <- sub('- A ', '', biz_data$StreetAddress)
biz_data$StreetAddress <- sub('-B ', '', biz_data$StreetAddress)
biz_data$StreetAddress <- sub('- B ', '', biz_data$StreetAddress)

# as data is not clean, there are sometimes suite number or other suffix follow them. therefore, we clean that part up too.
biz_data$StreetAddress <- sub(", #.*", '', biz_data$StreetAddress)
biz_data$StreetAddress <- sub(" #.*", '', biz_data$StreetAddress)
biz_data$StreetAddress <- sub("#.*", '', biz_data$StreetAddress)
biz_data$StreetAddress <- sub(" ,.*", '', biz_data$StreetAddress)
biz_data$StreetAddress <- sub(",.*", '', biz_data$StreetAddress)



#convert to Lat- Long  
#Reference https://www.youtube.com/watch?v=7nFZ5BwkAXc
biz_data$Address <- paste(biz_data$StreetAddress,biz_data$Licence.Address.Line.3, sep = ",")
biz_geo_loc = biz_data %>%
  select(Category,`Operating.Name`,Licence.Address.Line.3,Street, Address)
#  select(Category,`Operating.Name`,Licence.Address.Line.1,Licence.Address.Line.2,Licence.Address.Line.3,Street, Address)
biz_geo_loc = biz_geo_loc %>% filter(str_detect(Licence.Address.Line.3, "M5C|M5E"))
#area around M5C = M5H(W), M5B(N), M5E(S)


biz_geo_loc = biz_geo_loc %>%
#   slice(1:10) %>%
    tidygeocoder:: geocode(address = Address, method = "osm")

#check if any na
sapply(biz_geo_loc, function(x) sum(is.na(x)))

biz_geo_loc1 = biz_geo_loc[-which(is.na(biz_geo_loc$lat)),]
biz_geo_loc2 = biz_geo_loc[which(is.na(biz_geo_loc$lat)),]
